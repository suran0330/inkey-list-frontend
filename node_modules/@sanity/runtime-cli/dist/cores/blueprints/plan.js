import chalk from 'chalk';
import { getStack } from '../../actions/blueprints/stacks.js';
import { formatResourceTree, formatTitle, stackDeployDiff, } from '../../utils/display/blueprints-formatting.js';
export async function blueprintPlanCore(options) {
    const { bin = 'sanity', log, blueprint, token } = options;
    const { projectId, stackId, parsedBlueprint, fileInfo } = blueprint;
    log(`${formatTitle('Deployment', 'Plan')} ${chalk.dim(`(${fileInfo.fileName})`)}`);
    log(formatResourceTree(parsedBlueprint.resources));
    if (token && projectId && stackId) {
        const stackResponse = await getStack({ stackId, auth: { token, projectId } });
        if (!stackResponse.ok) {
            log(chalk.dim('Unable to retrieve live deployment for comparison'));
        }
        else {
            const diff = stackDeployDiff(parsedBlueprint, stackResponse.stack);
            if (diff)
                log(diff);
            else
                log(chalk.dim('No changes detected to live deployment'));
        }
    }
    log(chalk.dim(`Run ${bin} blueprints deploy to deploy these changes`));
    return { success: true };
}
